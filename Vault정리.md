# 📌 Vault 이론 정리

## 1. 🔑 Vault의 가장 큰 역할

Vault는 크게 두 가지 주요 목적을 가지고 사용된다:

### 1.1 키 관리(Key Management)

- 암복호화에 사용할 키를 안전하게 생성/저장/전달하는 목적
- 앱이 키를 받아와 자체적으로 암복호화를 수행

### 1.2 암복호화 수행(Encryption as a Service)

- Vault가 직접 암복호화를 수행 (대표적으로 **Transit Secrets Engine** 사용)
- 앱은 데이터를 Vault에 보내고, Vault가 암복호화하여 결과만 반환

---

## 2. ⚙️ 각 방식의 사용 흐름

### 2.1 키 관리 방식의 흐름

앱 → Vault: 암복호화 키 요청 ↓ 앱: 키 저장 (메모리/파일 등) ↓ 앱 자체적으로 암복호화 수행

### 2.2 암복호화(Transit) 방식의 흐름

앱 → Vault: 암복호화 요청 (평문/암호문 포함) ↓ Vault: 내부에서 키로 처리 (앱은 키를 모름) ↓ Vault → 앱: 결과 전달 (암호문/평문)

---

## 3. 🔒 보안 위험 등급 비교

| 항목                | 키 관리 방식                 | 암복호화(Transit) 방식       |
| ------------------- | ---------------------------- | ---------------------------- |
| 키 노출 가능성      | 앱이 직접 들고 있음 (⚠️높음) | Vault 내부에만 존재 (✅낮음) |
| Vault API 호출 빈도 | 낮음 (초기 1회)              | 높음 (요청마다 호출)         |
| 네트워크 비용       | 적음                         | 많음                         |
| 보안성              | 낮음                         | 높음                         |
| 구현 단순성         | 쉬움                         | 상대적으로 복잡              |

---

## 4. 🛡️ 위험 보완을 위한 설계 방식

### 4.1 인증 및 토큰 관리 전략

- Vault 접근에는 항상 인증(토큰 등)이 필요
- 인증 수단: AppRole, Kubernetes Auth, AWS IAM Auth 등
- 발급받은 **Vault 토큰**은 적절하게 보관/관리되어야 함

### 4.2 토큰 노출을 줄이기 위한 설계 옵션

| 방식                   | 설명                                         | 장점                      | 단점                       | Vault 토큰 위치                     |
| ---------------------- | -------------------------------------------- | ------------------------- | -------------------------- | ----------------------------------- |
| Vault Agent (Sink)     | 인증 후 토큰을 파일/ENV로 저장               | 자동화 용이               | 앱이 직접 토큰을 들고 다님 | 파일(`.vault-token`), ENV 변수      |
| Vault Agent (Proxy) ✅ | 앱은 Vault Agent에만 요청, Vault는 토큰 보유 | **앱이 토큰을 몰라도 됨** | 구성 복잡도 ↑              | Vault Agent 내부 캐시               |
| AppRole 방식           | 앱이 Role ID + Secret ID로 로그인            | 제어 가능                 | Secret ID 보안 이슈        | 앱 메모리 또는 ENV                  |
| Kubernetes Auth        | SA 토큰으로 인증, Vault가 토큰 발급          | K8s에 최적화              | SA 탈취 시 위험            | 앱 메모리, 파일 or Vault Agent 내부 |
| CSI + Secret 주입      | Pod 실행 시 secret을 직접 주입               | 앱이 Vault를 몰라도 됨    | Transit용도엔 부적합       | Vault가 주입, 앱은 토큰 필요 없음   |
| 외부 API 프록시        | 외부 시스템이 Vault와 통신                   | Vault 노출 최소화         | 중간 계층 필요             | 외부 서비스가 보유                  |

---

## 5. 🧩 Vault 보안을 위한 핵심 관리 대상

### 5.1 가장 민감한 요소: **Vault Token**

- Vault에서 실제 권한을 가지는 핵심 인증 요소
- 이 토큰이 탈취되면 Vault의 키/비밀 접근 가능

### 5.2 토큰을 안전하게 다루는 방법

- 최소 권한 부여 (least privilege policy)
- 짧은 TTL + 자동 폐기 설정
- Orphan 토큰 (부모 토큰과 무관하게 폐기 가능)
- 자동 갱신 설정 (Vault Agent auto-auth + renewal)
- Audit logging 활성화 (누가/언제/무엇을 요청했는지 추적)

---

## ✅ 결론

- Vault는 키 보관소이자, 암복호화 서비스로 사용할 수 있음
- Transit 방식이 보안적으로는 우수하지만, 인증과 토큰 관리가 핵심
- 토큰을 직접 사용하지 않도록 **Vault Agent 프록시**를 통한 우회 구조가 가장 이상적
- 그럼에도 불구하고, **토큰은 누군가가 반드시 보유해야 하므로**, 이 토큰을 **어디서, 어떻게, 얼마나 안전하게 다룰지**에 대한 설계가 Vault 보안의 핵심이다.
